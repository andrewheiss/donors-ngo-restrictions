---
title: "Get, clean, and merge data"
author: "Suparna Chaudhry and Andrew Heiss"
date: "`r format(Sys.time(), '%B %e, %Y')`"
output: 
  html_document: 
    css: ../html/fixes.css
    code_folding: hide
    toc: yes
    toc_float: true
    toc_depth: 4
    highlight: pygments
    self_contained: yes
    theme: spacelab
    includes:
      after_body: ../html/add_home_link.html
---

```{r load-libraries, message=FALSE}
knitr::opts_chunk$set(cache=FALSE, fig.retina=2,
                      tidy.opts=list(width.cutoff=120),  # For code
                      options(width=120))  # For output

library(tidyverse)
library(stringr)
library(lubridate)
library(httr)
library(countrycode)
library(pander)
library(DT)
library(xml2)


panderOptions('table.split.table', Inf)
panderOptions('table.split.cells', Inf)
panderOptions('keep.line.breaks', TRUE)
panderOptions('table.style', 'multiline')
panderOptions('table.alignment.default', 'left')
```

## Consistent country names

This is a perpetual nightmare in IR data. Here's a master lookup table of COW codes, ISO3 codes, and Gleditsch Ward codes. 

Gleditsch and Ward do not include a bunch of countries, so I create my own codes for relevant countries that appear in other datasets:

- Somaliland: 521
- Palestine (West Bank): 667
- Palestine (Gaza): 668
- Palestine (both): 669
- Hong Kong: 715

Also, [following Gleditsch and Ward](http://privatewww.essex.ac.uk/~ksg/data/iisyst_casedesc.pdf), I treat Serbia as 340 and Serbia & Montenegro as a continuation of Yugoslavia, or 345.

```{r load-gwcodes, message=FALSE}
# Gleditsch Ward codes
gw.date <- "%d:%m:%Y"
gw.states <- read_tsv("http://privatewww.essex.ac.uk/~ksg/data/iisystem.dat",
                      col_names=c("gwcode", "cowc", "country.name",
                                  "date.start", "date.end"),
                      col_types=cols(
                        gwcode = col_integer(),
                        cowc = col_character(),
                        country.name = col_character(),
                        date.start = col_date(format=gw.date),
                        date.end = col_date(format=gw.date)
                      ),
                      locale=locale(encoding="windows-1252"))

gw.microstates <- read_tsv("http://privatewww.essex.ac.uk/~ksg/data/microstatessystem.dat",
                           col_names=c("gwcode", "cowc", "country.name",
                                       "date.start", "date.end"),
                           col_types=cols(
                             gwcode = col_integer(),
                             cowc = col_character(),
                             country.name = col_character(),
                             date.start = col_date(format=gw.date),
                             date.end = col_date(format=gw.date)
                           ),
                           locale=locale(encoding="windows-1252"))

gw.codes <- bind_rows(gw.states, gw.microstates) %>%
  filter(date.end > ymd("2000-01-01")) %>%
  # Help out countrycode() 
  mutate(country.name = recode(country.name,
                               `Vietnam, Democratic Republic of` = "Vietnam",
                               `Yemen (Arab Republic of Yemen)` = "Yemen")) %>%
  mutate(iso3 = countrycode(country.name, "country.name", "iso3c"),
         cowcode = countrycode(iso3, "iso3c", "cown")) %>%
  mutate(iso3 = case_when(
    .$gwcode == 340 ~ "SRB",
    .$gwcode == 347 ~ "XKK",
    TRUE ~ .$iso3
  )) %>%
  mutate(cowcode = case_when(
    .$gwcode == 340 ~ as.integer(340),
    .$gwcode == 347 ~ as.integer(347),
    TRUE ~ .$cowcode
  )) %>%
  filter(!is.na(iso3)) %>%
  mutate(country.name = countrycode(iso3, "iso3c", "country.name"),
         country.name = ifelse(iso3 == "XKK", "Kosovo", country.name)) %>%
  select(country.name, iso3, gwcode, cowcode)

manual.gw <- tribble(
  ~country.name,            ~iso3,   ~gwcode,  ~cowcode,
  "Somaliland",             "SOL",   521,      521,     
  "Palestine (West Bank)",  "PWB",   667,      667,     
  "Palestine (Gaza)",       "PGZ",   668,      668,     
  "Palestine",              "PSE",   669,      669,     
  "Hong Kong",              "HKG",   715,      715
)

gw.codes <- bind_rows(gw.codes, manual.gw) %>% 
  arrange(country.name)

gw.codes %>% datatable()
```


## Foreign aid

### OECD and AidData

The OECD collects detailed data on all foreign aid flows (ODA) from OECD member countries (and some non-member countries), mulilateral organizations, and the Bill and Melinda Gates Foundation (for some reason they're the only nonprofit donor) to all DAC-eligible countries (and some non non-DAC-eligible countries). 

The OECD tracks all this in a centralized Creditor Reporting System database and provides a nice front end for it at [OECD.Stat](http://stats.oecd.org/) with an open (but inscrutable) API ([raw CRS data](http://stats.oecd.org/DownloadFiles.aspx?HideTopMenu=yes&DatasetCode=CRS1) is also available). There are a set of pre-built queries with information about ODA flows by donor, recipient, and sector (purpose), but the pre-built data sources do not include all dimensions of the data. For example, [Table DAC2a](http://stats.oecd.org/Index.aspx?DataSetCode=TABLE2A) includes columns for donor, recipient, year, and total ODA (e.g. the US gave \$X to Nigeria in 2008) , but does not indicate the purpose/sector for the ODA. [Table DAC5](http://stats.oecd.org/Index.aspx?DataSetCode=TABLE5) includes columns for the donor, sector, year, and total ODA (e.g. the US gave \$X for education in 2008), but does not include recipient information. 

Instead of using these pre-built queries or attempting to manipulate their parameters, it's possible to use the [OECD's QWIDS query builder](https://stats.oecd.org/qwids/) to create a custom download of data. However, it is slow and clunky and requires singificant munging and filtering after exporting. 

The solution to all of this is to use [data from AidData](http://aiddata.org/aiddata-research-releases), which imports raw data from the OECD, cleans it, verifies it, and makes it freely available on GitHub.

AidData offers multiple versions of the data, including a full release, a thin release, aggregated donor/recipient/year data, and aggregated donor/recipient/year/purpose data. For the purposes of this study, all we care about are ODA flows by donor, recipient, year, and purpose, which is one of the ready-made datasets. 

Notably, this aggregated data shows total aid *commitments*, not aid *disbursements*. Both types of ODA information are available from the OECD and it's possible to get them using OECD's raw data. However, [AidData notes](http://aiddata.org/faqs-about-our-data) that disbursment data is sticky and slowâ€”projects take a long time to fulfil and actual inflows of aid in a year can be tied to commitments made years before. Because we're interested in donor reactions to restrictions on NGOs, any reaction would be visible in the decision to commit money to aid, not in the ultimate disbursement of aid, which is most likely already legally obligated and allocated to the country regardless of restrictions.

So, we look at ODA *commitments*.

```{r load-aiddata, message=FALSE}
aiddata.url <- "https://github.com/AidData-WM/public_datasets/releases/download/v3.0/AidDataCore_ResearchRelease_Level1_v3.0.zip"
aiddata.path <- file.path(PROJHOME, "Data", "data_raw", "AidData")
aiddata.zip.name <- basename(aiddata.url)
aiddata.name <- tools::file_path_sans_ext(aiddata.zip.name)

aiddata.final.name <- "AidDataCoreDonorRecipientYearPurpose_ResearchRelease_Level1_v3.0.csv"

# Download AidData data if needed
if (!file.exists(file.path(aiddata.path, aiddata.final.name))) {
  aiddata.get <- GET(aiddata.url, 
                     write_disk(file.path(aiddata.path, aiddata.zip.name),
                                overwrite=TRUE), 
                     progress())
  unzip(file.path(aiddata.path, aiddata.zip.name), exdir=aiddata.path)
  
  # Clean up zip file and unnecessary CSV files
  file.remove(file.path(aiddata.path, aiddata.zip.name))
  list.files(aiddata.path, pattern="csv", full.names=TRUE) %>%
    map(~ ifelse(str_detect(.x, "DonorRecipientYearPurpose"), 0,
                 file.remove(file.path(.x))))
}

# Clean up AidData data
aiddata.raw <- read_csv(file.path(aiddata.path, aiddata.final.name),
                        col_types=cols(
                          donor = col_character(),
                          recipient = col_character(),
                          year = col_integer(),
                          coalesced_purpose_code = col_double(),
                          coalesced_purpose_name = col_character(),
                          commitment_amount_usd_constant_sum = col_double()
                        ))

aiddata.clean <- aiddata.raw %>%
  # Get rid of non-country recipients
  filter(!str_detect(recipient,
                     regex("regional|unspecified|multi|value|global|commission", 
                           ignore_case=TRUE))) %>%
  filter(year < 9999)

# Donor, recipient, and purpose details
# I pulled these country names out of the dropdown menu at OECD.Stat Table 2a online
dac.donors <- c("Australia", "Austria", "Belgium", "Canada", "Czech Republic",
                "Denmark", "Finland", "France", "Germany", "Greece", "Iceland",
                "Ireland", "Italy", "Japan", "Korea", "Luxembourg", "Netherlands",
                "New Zealand", "Norway", "Poland", "Portugal", "Slovak Republic",
                "Slovenia", "Spain", "Sweden", "Switzerland", "United Kingdom",
                "United States")

non.dac.donors <- c("Bulgaria", "Croatia", "Cyprus", "Estonia", "Hungary",
                    "Israel", "Kazakhstan", "Kuwait", "Latvia", "Liechtenstein",
                    "Lithuania", "Malta", "Romania", "Russia", "Saudi Arabia",
                    "Chinese Taipei", "Thailand", "Timor Leste", "Turkey",
                    "United Arab Emirates")

other.countries <- c("Brazil", "Chile", "Colombia", "India", "Monaco", "Qatar",
                     "South Africa", "Taiwan")

donors <- aiddata.clean %>%
  distinct(donor) %>%
  mutate(donor.type = case_when(
    .$donor %in% c(dac.donors, non.dac.donors, other.countries) ~ "Country",
    .$donor == "Bill & Melinda Gates Foundation" ~ "Private donor",
    TRUE ~ "Multilateral or IGO"
  ))

recipients <- aiddata.clean %>%
  distinct(recipient) %>%
  mutate(iso3 = countrycode(recipient, "country.name", "iso3c")) %>%
  mutate(iso3 = case_when(
    .$recipient == "Kosovo" ~ "XKX",
    .$recipient == "Serbia and Montenegro" ~ "YUG",
    TRUE ~ .$iso3
  )) %>%
  left_join(gw.codes, by="iso3") %>%
  # Get rid of tiny countries
  filter(!is.na(gwcode))

# Purposes
purposes <- aiddata.clean %>%
  count(coalesced_purpose_name)

# 
# purposes.url <- "https://www.oecd.org/dac/stats/documentupload/DAC_codeLists.xml"
# purpose.nodes <- read_xml(purposes.url) %>% xml_find_all("//codelist-item")
# 
# purpose.codes <- data_frame(
#   code = purpose.nodes %>% xml_find_first(".//code") %>% xml_text(),
#   category = purpose.nodes %>% xml_find_first(".//category") %>% xml_text(),
#   name = purpose.nodes %>% xml_find_first(".//name") %>% xml_text(),
#   description = purpose.nodes %>% xml_find_first(".//description") %>% xml_text()
# )
# 
# # Extract the general categories of aid purposes (i.e. the first three digits of the purpose codes)
# general.codes <- purpose.codes %>%
#   filter(code %in% as.character(100:1000) & str_detect(name, "^\\d")) %>%
#   mutate(code = as.integer(code)) %>%
#   select(purpose.category.code = code, purpose.category.name = name)

aiddata.final <- aiddata.clean %>%
  left_join(donors, by="donor") %>%
  left_join(recipients, by="recipient")
```

Summary of clean data from AidData:

```{r aiddata-summary}
glimpse(aiddata.clean)
```

### USAID

Details about their data


## NGO regulations

### NGO legislation

Christensen and Weinstein

### Civil society regulatory environment

V-Dem


## Neighboring states

That one R package

## Quality of governance

V-Dem or QoG


## Other controls

### World Bank

GDP per capita

### Other stuff


## Final clean combined data
