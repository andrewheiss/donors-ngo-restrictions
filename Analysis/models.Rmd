---
title: "Models"
author: "Suparna Chaudhry and Andrew Heiss"
date: "`r format(Sys.time(), '%B %e, %Y')`"
output: 
  html_document: 
    code_folding: hide
    css: ../html/fixes.css
    fig_height: 3.5
    fig_width: 5
    highlight: pygments
    includes:
      after_body: ../html/add_home_link.html
    theme: spacelab
    toc: yes
    toc_depth: 4
    toc_float: yes
---

```{r load-libraries, message=FALSE}
knitr::opts_chunk$set(cache=FALSE, fig.retina=2,
                      tidy.opts=list(width.cutoff=120),  # For code
                      options(width=120))  # For output

library(tidyverse)
library(stringr)
library(forcats)
library(stargazer)
library(lme4)
library(modelr)
library(broom)

source(file.path(PROJHOME, "lib", "graphics.R"))
source(file.path(PROJHOME, "lib", "pandoc.R"))
source(file.path(PROJHOME, "lib", "bayes.R"))

my.seed <- 1234
set.seed(my.seed)

run.rstan <- FALSE
```

```{r load-data, cache=TRUE, message=FALSE}
df.donor.country <- readRDS(file.path(PROJHOME, "Data", "data_clean",
                                      "df_donor_country.rds"))
df.donor <- readRDS(file.path(PROJHOME, "Data", "data_clean",
                              "df_donor.rds"))
df.country <- readRDS(file.path(PROJHOME, "Data", "data_clean",
                                "df_country.rds"))
df.country.aid <- readRDS(file.path(PROJHOME, "Data", "data_clean",
                                "df_country_aid.rds"))

df.country.aid.demean <- df.country.aid %>%
  group_by(cowcode) %>%
  mutate_at(vars(barriers.total, advocacy, entry, funding, 
                 polity, gdp.capita_log, gdp.capita, trade.pct.gdp, corruption, csre),
            funs(between = mean(., na.rm=TRUE),  # meaned
                 within = . - mean(., na.rm=TRUE)))  # demeaned

dcjw.questions.clean <- read_csv(file.path(PROJHOME, "Data", "data_clean",
                                           "dcjw_questions.csv"))
dcjw.responses.clean <- read_csv(file.path(PROJHOME, "Data", "data_clean",
                                           "dcjw_responses.csv"))
```

## General model specifications and controls

We use a standard set of controls in each model ([explained in more detail here](../Data/get_merge_data.html#other_controls_and_alternative_hypotheses)):

- Democracy: `polity`
- Wealth: `gdp.capita_log` (logged so it's on the same scale as the other variables) 
- Government capacity: `corruption`
- Bad stuff: `internal.conflict.past.5` and `natural_disaster.occurrence`

Following [Bell and Jones (2015)](http://dx.doi.org/10.1017/psrm.2014.7), we use random effects for country and year and use a combination of meaned and demeaned versions of each continuous variable to estimate both the within and between effects of each variable. 

$$ y_{i, t + 1} = \beta_0 + \beta_1 (x_{it} - \bar{x}_i) + \beta_2 \bar{x}_i + \ldots $$

This approach has multiple benefits. The coefficients for the demeaned variables are roughly equivalent to their corresponding coefficeints in a fixed effects model, but a fixed effects model assumes that the between effect (captured by the mean variables) is 0, which is not the case. A random effects model specified in this manner is more interpretable, as it clearly separates the within and between effects (again, within = demeaned, between = mean).

Here's proof of how it works in some simple models. Model 1 is a basic OLS with country fixed effects. Model 2 is a basic OLS with country random effects, but potentially misspecified, since the between and within effects are conflated. Model 3 is a basic OLS with country random effects specified with between (mean; $\bar{x}_i$) and within (demeaned; $x_{it} - \bar{x}_i$) coefficients. The demeaned/within coefficients in Model 3 are roughly the same as those in the fixed effects Model 1. If all missing values were removed with listwise deletion and *then* the group means were calculated, the within coefficients of Model 3 and the regular coefficients of Model 1 would be identical, as in Model 4.

```{r fixed-random-example, results="asis"}
mod.test.fe <- lm(total.oda_log_next_year ~ 
                    barriers.total + polity + gdp.capita_log + 
                    as.factor(cowcode),
                  data=df.country.aid.demean)

mod.test.re <- lmer(total.oda_log_next_year ~ 
                    barriers.total + polity + gdp.capita_log + 
                    (1 | cowcode),
                  data=df.country.aid.demean)

mod.test.re.fancy <- lmer(total.oda_log_next_year ~ 
                            barriers.total_between + barriers.total_within +
                            polity_between + polity_within + 
                            gdp.capita_log_between + gdp.capita_log_within +
                            (1 | cowcode),
                          data=df.country.aid.demean)

df.example.complete <- df.country.aid %>%
  select(cowcode, year, total.oda_log_next_year, 
         barriers.total, polity, gdp.capita_log) %>%
  filter(complete.cases(.)) %>%
  group_by(cowcode) %>%
  mutate_at(vars(-c(cowcode, year, total.oda_log_next_year)),
            funs(between = mean(.), within = . - mean(.)))

mod.test.re.complete <- lmer(total.oda_log_next_year ~ 
                               barriers.total_between + barriers.total_within +
                               polity_between + polity_within + 
                               gdp.capita_log_between + gdp.capita_log_within +
                               (1 | cowcode),
                             data=df.example.complete)

stargazer(mod.test.fe, mod.test.re, mod.test.re.fancy, mod.test.re.complete,
          type="html", omit="factor", 
          add.lines=list(c("Country fixed effects", rep("Yes", 4))),
          keep.stat=c("n"))
```


## H~1~: Donors reduce aid in response to legislation

> **H~1~**: In response to restrictive NGO legislation, bilateral, multilateral, and private donors may reduce their aid to repressive countries.

$$ln( \text{ODA} )_{i, t+1} = \text{NGO legislation}_{it} + \text{controls}_{it}$$

Our dependent variable for this hypothesis is the log of ODA (constant 2011 dollars), leaded by one year so we don't have to lag every other independent variable. 

We look at NGO legislation in a few different ways:

- `barriers.total`: Number of anti-NGO legal barriers in a country-year
- `barriers.total_new`: Indicator marking if a new anti-NGO barrier was passed in a country year
- `advocacy + entry + funding`: Number of anti-NGO legal barriers by type of barrier
- `advocacy_new + entry_new + funding_new`: Indicators marking new type of barrier
- `csre`: Civil society regulatory environment index (CSRE), ranging from roughly -4 to 4 (higher values = better civil society regulations)

```{r h1-models, warning=FALSE, message=FALSE}
mod.h1.barriers.total <- lmer(
  total.oda_log_next_year ~ 
    barriers.total_between + barriers.total_within +
    polity_between + polity_within + 
    gdp.capita_log_between + gdp.capita_log_within +
    trade.pct.gdp_between + trade.pct.gdp_within + 
    corruption_between + corruption_within +
    # Indicator variables don't need to be demeaned
    internal.conflict.past.5 + natural_disaster.occurrence +
    (1 | cowcode) + (1 | year),
  data=df.country.aid.demean)

mod.h1.barriers.new <- lmer(
  total.oda_log_next_year ~ 
    barriers.total_new +
    polity_between + polity_within + 
    gdp.capita_log_between + gdp.capita_log_within +
    trade.pct.gdp_between + trade.pct.gdp_within + 
    corruption_between + corruption_within +
    # Indicator variables don't need to be demeaned
    internal.conflict.past.5 + natural_disaster.occurrence +
    (1 | cowcode) + (1 | year),
  data=df.country.aid.demean)

mod.h1.type.total <- lmer(
  total.oda_log_next_year ~ 
    advocacy_between + advocacy_within +
    entry_between + entry_within +
    funding_between + funding_within +
    polity_between + polity_within + 
    gdp.capita_log_between + gdp.capita_log_within +
    trade.pct.gdp_between + trade.pct.gdp_within + 
    corruption_between + corruption_within +
    # Indicator variables don't need to be demeaned
    internal.conflict.past.5 + natural_disaster.occurrence +
    (1 | cowcode) + (1 | year),
  data=df.country.aid.demean)

mod.h1.type.new <- lmer(
  total.oda_log_next_year ~ 
    advocacy_new + entry_new + funding_new +
    polity_between + polity_within + 
    gdp.capita_log_between + gdp.capita_log_within +
    trade.pct.gdp_between + trade.pct.gdp_within + 
    corruption_between + corruption_within +
    # Indicator variables don't need to be demeaned
    internal.conflict.past.5 + natural_disaster.occurrence +
    (1 | cowcode) + (1 | year),
  data=df.country.aid.demean)

mod.h1.csre <- lmer(
  total.oda_log_next_year ~ 
    csre_between + csre_within +
    polity_between + polity_within + 
    gdp.capita_log_between + gdp.capita_log_within +
    trade.pct.gdp_between + trade.pct.gdp_within + 
    corruption_between + corruption_within +
    # Indicator variables don't need to be demeaned
    internal.conflict.past.5 + natural_disaster.occurrence +
    (1 | cowcode) + (1 | year),
  data=df.country.aid.demean)
```

```{r h1-models-bayes, warning=FALSE, message=FALSE}
if (run.rstan) {
  mod.h1.barriers.total.bayes <- stan_glmer(
    total.oda_log_next_year ~ 
      barriers.total_between + barriers.total_within +
      polity_between + polity_within + 
      gdp.capita_log_between + gdp.capita_log_within +
      trade.pct.gdp_between + trade.pct.gdp_within + 
      corruption_between + corruption_within +
      # Indicator variables don't need to be demeaned
      internal.conflict.past.5 + natural_disaster.occurrence +
      (1 | cowcode) + (1 | year),
    data=df.country.aid.demean, family=gaussian(),
    prior=normal(), prior_intercept=normal(),
    chains=CHAINS, iter=ITER, warmup=WARMUP, seed=BAYES.SEED)
  
  mod.h1.barriers.new.bayes <- stan_glmer(
    total.oda_log_next_year ~ 
      barriers.total_new +
      polity_between + polity_within + 
      gdp.capita_log_between + gdp.capita_log_within +
      trade.pct.gdp_between + trade.pct.gdp_within + 
      corruption_between + corruption_within +
      # Indicator variables don't need to be demeaned
      internal.conflict.past.5 + natural_disaster.occurrence +
      (1 | cowcode) + (1 | year),
    data=df.country.aid.demean, family=gaussian(),
    prior=normal(), prior_intercept=normal(),
    chains=CHAINS, iter=ITER, warmup=WARMUP, seed=BAYES.SEED)
  
  mod.h1.type.total.bayes <- stan_glmer(
    total.oda_log_next_year ~ 
      advocacy_between + advocacy_within +
      entry_between + entry_within +
      funding_between + funding_within +
      polity_between + polity_within + 
      gdp.capita_log_between + gdp.capita_log_within +
      trade.pct.gdp_between + trade.pct.gdp_within + 
      corruption_between + corruption_within +
      # Indicator variables don't need to be demeaned
      internal.conflict.past.5 + natural_disaster.occurrence +
      (1 | cowcode) + (1 | year),
    data=df.country.aid.demean, family=gaussian(),
    prior=normal(), prior_intercept=normal(),
    chains=CHAINS, iter=ITER, warmup=WARMUP, seed=BAYES.SEED)
  
  mod.h1.type.new.bayes <- stan_glmer(
    total.oda_log_next_year ~ 
      advocacy_new + entry_new + funding_new +
      polity_between + polity_within + 
      gdp.capita_log_between + gdp.capita_log_within +
      trade.pct.gdp_between + trade.pct.gdp_within + 
      corruption_between + corruption_within +
      # Indicator variables don't need to be demeaned
      internal.conflict.past.5 + natural_disaster.occurrence +
      (1 | cowcode) + (1 | year),
    data=df.country.aid.demean, family=gaussian(),
    prior=normal(), prior_intercept=normal(),
    chains=CHAINS, iter=ITER, warmup=WARMUP, seed=BAYES.SEED)
  
  mod.h1.csre.bayes <- stan_glmer(
    total.oda_log_next_year ~ 
      csre_between + csre_within +
      polity_between + polity_within + 
      gdp.capita_log_between + gdp.capita_log_within +
      trade.pct.gdp_between + trade.pct.gdp_within + 
      corruption_between + corruption_within +
      # Indicator variables don't need to be demeaned
      internal.conflict.past.5 + natural_disaster.occurrence +
      (1 | cowcode) + (1 | year),
    data=df.country.aid.demean, family=gaussian(),
    prior=normal(), prior_intercept=normal(),
    chains=CHAINS, iter=ITER, warmup=WARMUP, seed=BAYES.SEED)
}
```

### Results

```{r h1-table, results="asis"}
stargazer(mod.h1.barriers.total, mod.h1.barriers.new, 
          mod.h1.type.total, mod.h1.type.new, mod.h1.csre,
          type="html", omit="factor")
```

### Predicted ODA

`barriers.total_between` is significant at the 95% level in the first model, and it's substantially so. The grey band below indicates the 90% prediction interval, calculated with 1000 simulated draws from model results (these intervals are waaaay too big for now; they'll be more accurate when running the Bayesian models). One additional anti-NGO law is associated with a 36% increase in ODA in the following year *between* countries in the panel.

```{r h1-visualize, warning=FALSE}
new.data <- mod.h1.barriers.total@frame %>%
  select(-barriers.total_between) %>%
  summarise_all(typical) %>%
  mutate(id = 1) %>%
  right_join(expand.grid(barriers.total_between = seq(0, 12, 0.1),
                         id = 1), by="id")

plot.predict <- merTools::predictInterval(merMod=mod.h1.barriers.total, newdata=new.data, 
                                          level=0.90, n.sims=1000,
                                          stat="median", type="linear.prediction",
                                          include.resid.var=TRUE) %>%
  rename(pred = fit, pred.upper = upr, pred.lower = lwr) %>%
  bind_cols(augment(mod.h1.barriers.total, newdata=new.data))

ggplot(plot.predict, aes(x=barriers.total_between, y=.fitted)) + 
  geom_line() + 
  geom_ribbon(aes(ymin=pred.lower, ymax=pred.upper),
              alpha=0.3, colour=NA) + 
  labs(x="Total barriers (between; average value for each country)", y="Predicted log ODA") +
  theme_donors()
```

Looking at the overall effect of the civil society regulatory environment, though, does yield a significant effect. A one point increase in the CSRE is associated with a 41% increase in ODA in the following year (and vice versa; worsening CSRE leads to a reduction in aid) *within* countries in the panel.

```{r h1-visualize1, warning=FALSE}
new.data <- mod.h1.csre@frame %>%
  select(-csre_within) %>%
  summarise_all(typical) %>%
  mutate(id = 1) %>%
  right_join(expand.grid(csre_within = seq(-4, 4, 0.1),
                         id = 1), by="id")

plot.predict <- merTools::predictInterval(merMod=mod.h1.csre, newdata=new.data, 
                                          level=0.90, n.sims=1000,
                                          stat="median", type="linear.prediction",
                                          include.resid.var=TRUE) %>%
  rename(pred = fit, pred.upper = upr, pred.lower = lwr) %>%
  bind_cols(augment(mod.h1.csre, newdata=new.data))

ggplot(plot.predict, aes(x=csre_within, y=.fitted)) + 
  geom_line() + 
  geom_ribbon(aes(ymin=pred.lower, ymax=pred.upper),
              alpha=0.3, colour=NA) + 
  labs(x="CSRE (within; difference from mean)", y="Predicted log ODA") +
  theme_donors()
```
